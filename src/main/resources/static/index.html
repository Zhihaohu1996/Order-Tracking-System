<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>销售订单跟踪系统</title>
  <style>
    :root { --border:#e5e7eb; --bg:#f8fafc; --text:#0f172a; --muted:#64748b; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; color:var(--text); background:var(--bg); }
    header { padding:14px 18px; background:#fff; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:12px; flex-wrap:wrap;}
    header h1 { font-size:16px; margin:0; font-weight:700; }
    .pill { font-size:12px; color:var(--muted); }
    .btn { border:1px solid var(--border); background:#fff; padding:8px 10px; border-radius:10px; cursor:pointer; }
    .btn.primary { background:#0f172a; color:#fff; border-color:#0f172a; }
    .btn.danger { border-color:#ef4444; color:#ef4444; background:#fff; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    select, input, textarea { border:1px solid var(--border); border-radius:10px; padding:8px 10px; font-size:14px; background:#fff; }
    textarea { min-height:72px; resize:vertical; }
    main { display:grid; grid-template-columns: 1.25fr 1fr; gap:14px; padding:14px; }
    .card { background:#fff; border:1px solid var(--border); border-radius:14px; padding:12px; box-shadow:0 1px 1px rgba(0,0,0,.02); }
    .card h2 { margin:0 0 10px 0; font-size:14px; }
    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid var(--border); padding:8px 6px; font-size:13px; text-align:left; vertical-align:top; }
    th { color:var(--muted); font-weight:600; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .row3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    .mt { margin-top:10px; }
    .muted { color:var(--muted); font-size:12px; }
    .error { color:#ef4444; font-size:12px; white-space:pre-wrap; }
    .ok { color:#16a34a; font-size:12px; white-space:pre-wrap; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .divider { height:1px; background:var(--border); margin:12px 0; }
    .section-title { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:12px; }
    .section-title h3 { margin:0; font-size:13px; }
    .mini { font-size:12px; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; background:#f1f5f9; border:1px solid var(--border); border-radius:8px; padding:2px 6px; }

    /* Order photos */
    .photo-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:12px; }
    .photo-item { border:1px solid var(--border); border-radius:16px; padding:10px; background:#fff; }
    .photo-item img { width:100%; height:110px; object-fit:cover; border-radius:12px; border:1px solid var(--border); }
    .photo-meta { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:8px; }
    .photo-name { font-size:12px; color:var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .btn.danger { border-color:#fecaca; color:#b91c1c; }
  
    /* ===== Order list filters ===== */
    .filters {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      margin: 10px 0 12px;
    }
    .filters .input { flex: 1; min-width: 220px; }
    .filters .select { min-width: 160px; }
    .filters .muted { font-size: 12px; color: #6b7280; }

</style>
</head>
<body>

<div id="loginOverlay" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(15,23,42,.35);z-index:50;">
  <div class="card" style="width:360px;">
    <h2>登录</h2>
    <div class="row">
      <div>
        <div class="muted">用户名</div>
        <input id="loginUser" placeholder="用户名" autocomplete="username" />
      </div>
      <div>
        <div class="muted">密码</div>
        <input id="loginPass" type="password" placeholder="密码" autocomplete="current-password" />
      </div>
    </div>
    <div class="actions mt">
      <button class="btn primary" id="btnLogin">登录</button>
    </div>
    <div class="error mt" id="loginErr"></div>
    <div class="muted mt">管理员可在“用户管理”里创建账号并设置密码。</div>
  </div>
</div>


<div id="importOverlay" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(15,23,42,.35);z-index:49;">
  <div class="card" style="width:min(900px,94vw);max-height:88vh;overflow:auto;">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
      <h2 style="margin:0;">导入订单</h2>
      <button class="btn" id="btnImportClose">关闭</button>
    </div>

    <div class="muted mt">
      支持两种方式：上传 <b>Excel (.xlsx/.xls)</b> / <b>CSV (.csv)</b> 文件，或直接粘贴表格文本（从 Excel 复制后粘贴即可）。
      <br/>要求：必须包含 <b>orderNo / 订单号</b> 列。每行代表一个“订单明细行”，相同订单号会自动合并为一个订单。
      <br/>重复订单号处理：如果数据库里已存在任意一个订单号，将 <b>直接中止</b> 导入并提示重复的订单号（不会部分导入）。
    </div>

    <div class="mt" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
      <div class="card" style="padding:14px;">
        <h3 style="margin:0 0 8px 0;">方式 1：上传文件</h3>
        <input id="importFile" type="file" accept=".xlsx,.xls,.csv" />
        <div class="actions mt">
          <button class="btn primary" id="btnImportFile">开始导入文件</button>
        </div>
        <div class="muted mt" style="font-size:12px;">
          建议表头（可中英文混用）：
          <pre style="white-space:pre-wrap;">orderNo, customerName, customerContact, currency, paymentTerms, totalAmount, productRequirements, packagingRequirements, productName, spec, quantity, unitPrice, remark</pre>
        </div>
      </div>

      <div class="card" style="padding:14px;">
        <h3 style="margin:0 0 8px 0;">方式 2：粘贴表格文本</h3>
        <textarea id="importText" rows="10" placeholder="粘贴包含表头的表格文本（建议从 Excel 复制后粘贴，默认按 TAB 分隔；也支持逗号分隔 CSV 文本）"></textarea>
        <div class="actions mt">
          <button class="btn primary" id="btnImportText">开始导入粘贴内容</button>
        </div>
        <div class="muted mt" style="font-size:12px;">
          提示：第一行必须是表头。粘贴多行时，相同 orderNo 会自动合并为一个订单。
        </div>
      </div>
    </div>

    <div class="error mt" id="importErr"></div>
  </div>
</div>

<header>
  <h1>销售订单跟踪系统</h1>
  <span class="pill" id="userPill">未登录</span>

  <label class="pill">当前账号角色：
    <select id="roleSelect" disabled>
      <option>GM</option>
      <option>SALES</option>
      <option>PMC</option>
      <option>PRODUCTION</option>
      <option>PRODUCTION</option>
      <option>GUEST</option>
    </select>
  </label>

  <button class="btn" id="btnUserMgmt" style="display:none;">用户管理</button>
  <button class="btn" id="btnAuditLogs" style="display:none;">操作记录</button>
  <button class="btn" id="btnLogout" style="display:none;">退出登录</button>

  <button class="btn" id="btnRefresh">刷新列表</button>
  <button class="btn primary" id="btnNew">新建订单</button>

  <span class="muted" id="globalMsg"></span>
</header>

<main>
  <div class="card">
    <h2>订单列表</h2>
    <div class="muted">提示：非 GM/SALES 角色会自动隐藏客户/金额/单价等敏感字段。</div>

    <div class="filters">
      <input id="orderSearch" class="input" type="text" placeholder="搜索：订单号 / 状态 / 客户（若可见）" />
      <select id="statusFilter" class="select">
        <option value="">全部状态</option>
      </select>
      <button id="btnExportCsv" class="btn">导出 CSV</button>
      <button id="btnImportOrders" class="btn">导入订单</button>
      <span id="filterStats" class="muted"></span>
    </div>

    <div class="mt"></div>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>订单号</th>
          <th>状态</th>
          <th>客户</th>
          <th>总金额</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="orderTbody"></tbody>
    </table>
    <div class="error mt" id="listErr"></div>
  </div>

  <div class="card" id="rightCard">
    <!-- dynamic -->
  </div>
</main>

<script>
const apiBase = '/api/orders';

const roleSelect = document.getElementById('roleSelect');
const btnRefresh = document.getElementById('btnRefresh');
const btnNew = document.getElementById('btnNew');
const orderTbody = document.getElementById('orderTbody');
const rightCard = document.getElementById('rightCard');
const globalMsg = document.getElementById('globalMsg');
const listErr = document.getElementById('listErr');
const loginOverlay = document.getElementById('loginOverlay');
const loginUser = document.getElementById('loginUser');
const loginPass = document.getElementById('loginPass');
const btnLogin = document.getElementById('btnLogin');
const loginErr = document.getElementById('loginErr');
const userPill = document.getElementById('userPill');
const btnLogout = document.getElementById('btnLogout');
const btnUserMgmt = document.getElementById('btnUserMgmt');
const btnAuditLogs = document.getElementById('btnAuditLogs');
const btnImportOrders = document.getElementById('btnImportOrders');

const importOverlay = document.getElementById('importOverlay');
const btnImportClose = document.getElementById('btnImportClose');
const btnImportCancel = document.getElementById('btnImportCancel');
const importFile = document.getElementById('importFile');
const btnImportFile = document.getElementById('btnImportFile');
const importText = document.getElementById('importText');
const btnImportText = document.getElementById('btnImportText');
const importErr = document.getElementById('importErr');

let authUser = null;
let authRole = null;

function showLogin(show) {
  loginErr.textContent = '';
  loginOverlay.style.display = show ? 'flex' : 'none';
}

function showImport(show) {
  importErr.textContent = '';
  importOverlay.style.display = show ? 'flex' : 'none';
  if (show) {
    importFile.value = '';
    importText.value = '';
  }
}

function setUserPill() {
  if (!authUser) {
    userPill.textContent = '未登录';
    btnLogout.style.display = 'none';
    btnUserMgmt.style.display = 'none';
    btnAuditLogs.style.display = 'none';
    btnImportOrders.style.display = 'none';
    return;
  }
  userPill.textContent = `已登录：${authUser}（${authRole}）`;
  btnLogout.style.display = '';
  btnUserMgmt.style.display = (authRole === 'GM') ? '' : 'none';
  btnAuditLogs.style.display = (authRole === 'GM') ? '' : 'none';
  btnImportOrders.style.display = (authRole === 'GM' || authRole === 'SALES') ? '' : 'none';
}

async function refreshMe() {
  const res = await fetch('/api/auth/me', { credentials: 'include' });
  if (!res.ok) {
    authUser = null;
    authRole = null;
    roleSelect.value = 'GUEST';
    setUserPill();
    return null;
  }
  const me = await res.json();
  authUser = me.username;
  authRole = me.role;
  roleSelect.value = authRole || 'GUEST';
  setUserPill();
  return me;
}

async function doLogin() {
  const username = loginUser.value.trim();
  const password = loginPass.value;
  if (!username || !password) {
    loginErr.textContent = '请输入用户名和密码';
    return;
  }
  const res = await fetch('/api/auth/login', {
    method: 'POST',
    credentials: 'include',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, password })
  });
  if (!res.ok) {
    const t = await res.text();
    loginErr.textContent = t || '登录失败';
    return;
  }
  await refreshMe();
  showLogin(false);
  await loadList();
}

async function doLogout() {
  await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
  authUser = null;
  authRole = null;
  roleSelect.value = 'GUEST';
  setUserPill();
  showLogin(true);
}



// --- Bulk import orders (GM / SALES) ---
if (btnImportOrders) {
  btnImportOrders.onclick = () => {
    if (!authUser) {
      showLogin(true);
      return;
    }
    showImport(true);
  };
}
if (btnImportClose) btnImportClose.onclick = () => showImport(false);
if (btnImportCancel) btnImportCancel.onclick = () => showImport(false);

async function importOrdersFromFile() {
  importErr.textContent = '';
  if (!importFile.files || importFile.files.length === 0) {
    importErr.textContent = '请选择一个 CSV / Excel 文件';
    return;
  }
  const fd = new FormData();
  fd.append('file', importFile.files[0]);
  const res = await fetch('/api/orders/import/file', {
    method: 'POST',
    credentials: 'include',
    headers: { 'X-ROLE': roleSelect.value },
    body: fd
  });
  if (!res.ok) {
    const t = await res.text();
    importErr.textContent = t || '导入失败';
    return;
  }
  const r = await res.json();
  showImport(false);
  await loadList();
  alert(`导入成功：订单 ${r.ordersImported} 个，明细 ${r.itemsImported} 条`);
}

async function importOrdersFromText() {
  importErr.textContent = '';
  const text = (importText.value || '').trim();
  if (!text) {
    importErr.textContent = '请粘贴表格内容';
    return;
  }
  const res = await fetch('/api/orders/import/text', {
    method: 'POST',
    credentials: 'include',
    headers: headers(),
    body: JSON.stringify({ text })
  });
  if (!res.ok) {
    const t = await res.text();
    importErr.textContent = t || '导入失败';
    return;
  }
  const r = await res.json();
  showImport(false);
  await loadList();
  alert(`导入成功：订单 ${r.ordersImported} 个，明细 ${r.itemsImported} 条`);
}

if (btnImportFile) btnImportFile.onclick = importOrdersFromFile;
if (btnImportText) btnImportText.onclick = importOrdersFromText;



// --- Admin: user management (GM only) ---
function userRow(u){
  const enabled = u.enabled ? '是' : '否';
  const btnToggle = u.enabled ? '禁用' : '启用';
  return `<tr>
    <td>${u.id}</td>
    <td>${u.username}</td>
    <td>${u.role}</td>
    <td>${enabled}</td>
    <td style="display:flex; gap:6px; flex-wrap:wrap;">
      <button class="btn mini" data-um-act="reset" data-id="${u.id}">重置密码</button>
      <button class="btn mini" data-um-act="toggle" data-id="${u.id}" data-enabled="${u.enabled ? '1' : '0'}">${btnToggle}</button>
      <button class="btn danger mini" data-um-act="del" data-id="${u.id}" data-name="${escapeHtml(u.username)}">删除</button>
    </td>
  </tr>`;
}

async function refreshUserMgmt(){
  const tbody = document.getElementById('umTable');
  const err = document.getElementById('umErr');
  if (!tbody) return;
  err.textContent = '';
  const users = await apiAdmin('/admin/users');
  tbody.innerHTML = users.map(userRow).join('');

  tbody.querySelectorAll('button[data-um-act]').forEach(btn => btn.addEventListener('click', async (ev) => {
    const act = ev.target.getAttribute('data-um-act');
    const id = ev.target.getAttribute('data-id');
    if (!id) return;
    if (act === 'reset') {
      await resetUserPassword(id);
      return;
    }
    if (act === 'toggle') {
      const enabled = ev.target.getAttribute('data-enabled') === '1';
      await setUserEnabled(id, !enabled);
      await refreshUserMgmt();
      return;
    }
    if (act === 'del') {
      const name = ev.target.getAttribute('data-name') || '';
      await deleteUser(id, name);
      await refreshUserMgmt();
      return;
    }
  }));
}

async function setUserEnabled(id, enabled){
  await apiAdmin(`/admin/users/${id}/enabled`, {
    method: 'PUT',
    headers: headers(),
    body: JSON.stringify({ enabled })
  });
}

async function deleteUser(id, name){
  if (!confirm(`确定删除用户 ${name || id} 吗？删除后无法恢复。`)) return;
  await apiAdmin(`/admin/users/${id}`, {
    method: 'DELETE',
    headers: headers()
  });
  alert('已删除');
}

async function createUser(){
  const err = document.getElementById('umErr');
  err.textContent = '';
  const username = document.getElementById('umName').value.trim();
  const password = document.getElementById('umPass').value;
  const role = document.getElementById('umRole').value;
  if (!username || !password) {
    err.textContent = '请填写用户名和密码';
    return;
  }
  await apiAdmin('/admin/users', {
    method: 'POST',
    headers: headers(),
    body: JSON.stringify({ username, password, role })
  });
  document.getElementById('umPass').value = '';
  await refreshUserMgmt();
}

async function resetUserPassword(id){
  const newPass = prompt('输入新密码（会立即生效）:');
  if (!newPass) return;
  await apiAdmin(`/admin/users/${id}/password`, {
    method: 'PUT',
    headers: headers(),
    body: JSON.stringify({ password: newPass })
  });
  alert('密码已更新');
}

async function openUserMgmt(){
  if (authRole !== 'GM') {
    alert('只有GM账号可以管理用户');
    return;
  }
  setRight( `
    <div class="card">
      <h2>用户管理（管理员）</h2>
      <div class="muted">创建账号后，员工用自己的用户名/密码登录系统。角色决定权限。</div>
      <div class="mt"></div>
      <div class="row">
        <div>
          <div class="muted">用户名</div>
          <input id="umName" placeholder="例如: warehouse1" />
        </div>
        <div>
          <div class="muted">密码</div>
          <input id="umPass" type="password" placeholder="设置初始密码" />
        </div>
      </div>
      <div class="row">
        <div>
          <div class="muted">角色</div>
          <select id="umRole">
            <option value="GM">GM（管理员）</option>
            <option value="SALES">SALES（销售）</option>
            <option value="WAREHOUSE">PRODUCTION（生产）</option>
          </select>
        </div>
        <div class="actions" style="align-self:end">
          <button class="btn primary" id="umCreateBtn">创建用户</button>
        </div>
      </div>
      <div class="error mt" id="umErr"></div>
      <div class="mt"></div>
      <table class="table">
        <thead><tr><th>ID</th><th>用户名</th><th>角色</th><th>启用</th><th>操作</th></tr></thead>
        <tbody id="umTable"></tbody>
      </table>
    </div>
  `);
  document.getElementById('umCreateBtn').onclick = createUser;
  await refreshUserMgmt();
}

// ----- Audit logs (GM only) -----
let auditState = {
  page: 0,
  size: 20,
  q: '',
  action: '',
  username: '',
  status: '',
  from: '',
  to: ''
};

function auditActions() {
  return [
    '',
    'LOGIN','LOGOUT',
    'CREATE_ORDER','UPDATE_ORDER','DELETE_ORDER',
    'IMPORT_ORDERS',
    'UPLOAD_PHOTO','DELETE_PHOTO',
    'ADMIN_CREATE_USER','ADMIN_RESET_PASSWORD','ADMIN_SET_ENABLED','ADMIN_DELETE_USER',
    'WAREHOUSE_RECEIPT_LOG','WAREHOUSE_RECEIPT_CONFIRM','SHIP_CONFIRM'
  ];
}

function buildAuditQuery(){
  const p = new URLSearchParams();
  p.set('page', String(auditState.page||0));
  p.set('size', String(auditState.size||20));
  if (auditState.q) p.set('q', auditState.q);
  if (auditState.action) p.set('action', auditState.action);
  if (auditState.username) p.set('username', auditState.username);
  if (auditState.status) p.set('status', auditState.status);
  if (auditState.from) p.set('from', auditState.from);
  if (auditState.to) p.set('to', auditState.to);
  return p.toString();
}

function fmtTime(iso){
  if (!iso) return '—';
  // ISO like 2026-01-10T15:00:00
  return String(iso).replace('T',' ').slice(0,19);
}

function auditRow(a){
  return `
    <tr>
      <td>${escapeHtml(fmtTime(a.createdAt))}</td>
      <td>${escapeHtml(a.username || '—')}</td>
      <td>${escapeHtml(a.role || '—')}</td>
      <td>${escapeHtml(a.action || '—')}</td>
      <td>${escapeHtml(a.target || '—')}</td>
      <td>${escapeHtml(a.status || '—')}</td>
      <td>${escapeHtml(a.ip || '—')}</td>
      <td title="${escapeHtml(a.details || '')}" style="max-width:360px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(a.details || '—')}</td>
    </tr>
  `;
}

async function refreshAuditLogs(pageOverride=null){
  const err = document.getElementById('alErr');
  const tbody = document.getElementById('alTable');
  const pager = document.getElementById('alPager');
  if (!tbody) return;
  if (pageOverride !== null) auditState.page = pageOverride;
  err.textContent = '';
  tbody.innerHTML = `<tr><td colspan="8" class="muted">加载中...</td></tr>`;
  try {
    const data = await apiAdmin('/audit-logs?' + buildAuditQuery());
    const list = Array.isArray(data.content) ? data.content : [];
    tbody.innerHTML = list.length ? list.map(auditRow).join('') : `<tr><td colspan="8" class="muted">暂无记录</td></tr>`;
    pager.textContent = `第 ${Number(data.page)+1} 页 / 共 ${data.totalPages} 页（总计 ${data.totalElements} 条）`;

    document.getElementById('alPrev').disabled = (data.page <= 0);
    document.getElementById('alNext').disabled = (data.page >= data.totalPages - 1);
  } catch(e) {
    err.textContent = e.message || '加载失败';
    tbody.innerHTML = '';
  }
}

function readAuditFilters(){
  auditState.q = document.getElementById('alQ').value.trim();
  auditState.action = document.getElementById('alAction').value;
  auditState.username = document.getElementById('alUser').value.trim();
  auditState.status = document.getElementById('alStatus').value;
  auditState.size = parseInt(document.getElementById('alSize').value || '20', 10);
  // datetime-local returns 'YYYY-MM-DDTHH:MM'
  const from = document.getElementById('alFrom').value;
  const to = document.getElementById('alTo').value;
  auditState.from = from ? (from + ':00') : '';
  auditState.to = to ? (to + ':00') : '';
}

async function openAuditLogs(){
  if (authRole !== 'GM') {
    alert('只有GM账号可以查看操作记录');
    return;
  }

  const actions = auditActions().map(a => {
    if (!a) return `<option value="">全部动作</option>`;
    return `<option value="${a}">${a}</option>`;
  }).join('');

  setRight(`
    <div class="card">
      <h2>操作记录 / Audit Logs（管理员）</h2>
      <div class="muted">支持搜索、过滤、分页。只显示最近记录（按时间倒序）。</div>

      <div class="filters mt" style="gap:8px; flex-wrap:wrap;">
        <input id="alQ" class="input" type="text" placeholder="搜索：用户/动作/目标/IP/详情" style="min-width:220px;" />
        <select id="alAction" class="select">${actions}</select>
        <input id="alUser" class="input" type="text" placeholder="用户名(精确)" style="width:160px;" />
        <select id="alStatus" class="select">
          <option value="">全部状态</option>
          <option value="SUCCESS">SUCCESS</option>
          <option value="FAIL">FAIL</option>
        </select>
        <input id="alFrom" class="input" type="datetime-local" title="开始时间" />
        <input id="alTo" class="input" type="datetime-local" title="结束时间" />
        <select id="alSize" class="select" title="每页条数">
          <option value="10">10/页</option>
          <option value="20" selected>20/页</option>
          <option value="50">50/页</option>
          <option value="100">100/页</option>
        </select>
        <button class="btn" id="alApply">应用</button>
        <button class="btn" id="alClear">清空</button>
      </div>

      <div class="mt"></div>
      <table class="table">
        <thead>
          <tr>
            <th style="min-width:140px;">时间</th>
            <th>用户</th>
            <th>角色</th>
            <th>动作</th>
            <th>目标</th>
            <th>状态</th>
            <th>IP</th>
            <th>详情</th>
          </tr>
        </thead>
        <tbody id="alTable"></tbody>
      </table>

      <div class="row mt" style="justify-content:space-between; align-items:center;">
        <div class="muted" id="alPager"></div>
        <div class="actions">
          <button class="btn" id="alPrev">上一页</button>
          <button class="btn" id="alNext">下一页</button>
        </div>
      </div>

      <div class="error mt" id="alErr"></div>
    </div>
  `);

  document.getElementById('alApply').onclick = async () => {
    readAuditFilters();
    await refreshAuditLogs(0);
  };
  document.getElementById('alClear').onclick = async () => {
    document.getElementById('alQ').value = '';
    document.getElementById('alAction').value = '';
    document.getElementById('alUser').value = '';
    document.getElementById('alStatus').value = '';
    document.getElementById('alFrom').value = '';
    document.getElementById('alTo').value = '';
    document.getElementById('alSize').value = '20';
    auditState = { page:0, size:20, q:'', action:'', username:'', status:'', from:'', to:'' };
    await refreshAuditLogs(0);
  };
  document.getElementById('alPrev').onclick = async () => {
    await refreshAuditLogs(Math.max(0, (auditState.page||0) - 1));
  };
  document.getElementById('alNext').onclick = async () => {
    await refreshAuditLogs((auditState.page||0) + 1);
  };
  document.getElementById('alQ').addEventListener('keydown', (e) => { if (e.key === 'Enter') document.getElementById('alApply').click(); });

  // First load
  await refreshAuditLogs(0);
}

let currentOrder = null;
let allOrders = [];

function headers() {
  return {
    'Content-Type': 'application/json',
    'X-ROLE': roleSelect.value
  };
}

function fmt(v) {
  if (v === null || v === undefined || v === '') return '—';
  return v;
}
function fmtMoney(v) {
  if (v === null || v === undefined) return '***';
  return v;
}
function escapeHtml(s) {
  if (s === null || s === undefined) return '';
  return String(s)
    .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
    .replaceAll('"','&quot;').replaceAll("'",'&#039;');
}
function toDateInputValue(d) {
  return d ? String(d).slice(0,10) : '';
}
async function api(path, opts={}) {
  // Always send cookies (session)
  if (!opts.credentials) opts.credentials = 'include';

  // Default headers: keep X-ROLE for backward compatibility (server will override by login role)
  const h = Object.assign({}, opts.headers || {});
  if (!h['X-ROLE']) h['X-ROLE'] = roleSelect.value || 'GUEST';
  opts.headers = h;

  const res = await fetch(apiBase + path, opts);
  const text = await res.text();
  let data = null;
  try { data = text ? JSON.parse(text) : null; } catch { data = text; }

  if (res.status === 401 || res.status === 403) {
    // 统一使用 showLogin() 控制登录弹窗
    showLogin(true, '请先登录');
    throw new Error('未登录');
  }

  if (!res.ok) {
    const msg = (data && data.message) ? data.message : (typeof data === 'string' ? data : '请求失败');
    throw new Error(msg);
  }
  return data;
}


async function apiAdmin(path, opts={}) {
  // Admin endpoints are under /api (not /api/orders)
  if (!opts.credentials) opts.credentials = 'include';

  const h = Object.assign({}, opts.headers || {});
  if (!h['X-ROLE']) h['X-ROLE'] = roleSelect.value || 'GUEST';
  opts.headers = h;

  const res = await fetch('/api' + path, opts);
  const text = await res.text();
  let data = null;
  try { data = text ? JSON.parse(text) : null; } catch { data = text; }

  if (res.status === 401 || res.status === 403) {
    showLogin(true, '请先登录');
    throw new Error('未登录');
  }

  if (!res.ok) {
    const msg = (data && data.message) ? data.message : (typeof data === 'string' ? data : '请求失败');
    throw new Error(msg);
  }
  return data;
}

// ----- Photos (per order) -----
function renderPhotos(list) {
  const grid = document.getElementById('photoGrid');
  if (!grid) return;
  if (!Array.isArray(list) || list.length === 0) {
    grid.innerHTML = `<div class="muted mini">暂无照片</div>`;
    return;
  }
  grid.innerHTML = list.map(p => {
    const name = escapeHtml(p.originalFilename || 'photo');
    const url = p.url || '';
    return `
      <div class="photo-item">
        <img class="photo-thumb" src="${url}" alt="${name}" />
        <div class="row" style="align-items:flex-start; justify-content:space-between; gap:8px;">
          <div class="photo-meta" title="${name}">${name}</div>
          <button class="btn danger mini" data-photo-del="${p.id}">删除</button>
        </div>
      </div>
    `;
  }).join('');
}

async function loadPhotos(orderId) {
  const grid = document.getElementById('photoGrid');
  if (!grid) return;
  try {
    grid.innerHTML = `<div class="muted mini">加载中...</div>`;
    const list = await api(`/${orderId}/photos`, { headers: headers() });
    renderPhotos(list);
  } catch (e) {
    grid.innerHTML = `<div class="error">加载照片失败：${escapeHtml(e.message || String(e))}</div>`;
  }
}

function wirePhotos(orderId) {
  const input = document.getElementById('photoFiles');
  const btnUpload = document.getElementById('btnUploadPhotos');
  const msg = document.getElementById('photoMsg');
  const grid = document.getElementById('photoGrid');
  if (!input || !btnUpload || !grid) return;

  btnUpload.onclick = async () => {
    msg.textContent = '';
    const files = Array.from(input.files || []);
    if (files.length === 0) {
      toast('请选择图片');
      return;
    }

    try {
      btnUpload.disabled = true;
      msg.textContent = '上传中...';

      // Upload one by one (simple + reliable)
      for (const f of files) {
        const fd = new FormData();
        fd.append('file', f);
        const r = await fetch(`/api/orders/${orderId}/photos`, {
          method: 'POST',
          credentials: 'include',
          headers: { 'X-ROLE': roleSelect.value },
          body: fd
        });
        if (!r.ok) throw new Error(await r.text());
      }

      input.value = '';
      msg.textContent = '上传成功';
      await loadPhotos(orderId);
    } catch (e) {
      msg.textContent = '';
      toast('上传失败：' + (e.message || e));
    } finally {
      btnUpload.disabled = false;
    }
  };

  grid.onclick = async (ev) => {
    const btn = ev.target.closest('[data-photo-del]');
    if (!btn) return;
    const photoId = btn.getAttribute('data-photo-del');
    if (!photoId) return;
    if (!confirm('删除这张照片？')) return;
    try {
      await fetch(`/api/photos/${photoId}`, {
        method: 'DELETE',
        credentials: 'include',
        headers: { 'X-ROLE': roleSelect.value }
      });
      await loadPhotos(orderId);
    } catch (e) {
      toast('删除失败：' + (e.message || e));
    }
  };
}

function setRight(html) {
  rightCard.innerHTML = html;
}

function can(role, what) {
  // Very simple UI control (backend is source of truth).
  const r = roleSelect.value;
  if (r === 'GM') return true;
  if (what === 'editOrder') return r === 'SALES';
  if (what === 'plan') return r === 'PMC';
  if (what === 'process') return r === 'PRODUCTION' || r === 'PMC';
  if (what === 'warehouse') return r === 'WAREHOUSE';
  if (what === 'shipPlan') return r === 'SALES';
  return false;
}



async function loadList() {
  listErr.textContent = '';
  orderTbody.innerHTML = '<tr><td colspan="6" class="muted">加载中...</td></tr>';
  try {
    const list = await api('', { method: 'GET', headers: headers() });
    allOrders = Array.isArray(list) ? list : [];
    updateStatusFilterOptions(allOrders);
    renderOrderList(getFilteredOrders());
  } catch (e) {
    listErr.textContent = e.message;
    orderTbody.innerHTML = '';
  }
}

function getSelectedRole() {
  // roleSelect is the "当前账号角色" dropdown (for demo/permission simulation)
  return (roleSelect && roleSelect.value) ? roleSelect.value : (currentUser && currentUser.role) ? currentUser.role : 'GM';
}

function canSeeSensitive() {
  const r = getSelectedRole();
  return r === 'GM' || r === 'SALES';
}

function updateStatusFilterOptions(list) {
  const sel = document.getElementById('statusFilter');
  if (!sel) return;
  const cur = sel.value || '';
  const statuses = Array.from(new Set((list || []).map(o => o && o.status).filter(Boolean))).sort();
  sel.innerHTML = '<option value="">全部状态</option>' +
    statuses.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');
  if (cur === '' || statuses.includes(cur)) sel.value = cur;
}

function getFilteredOrders() {
  const q = (document.getElementById('orderSearch')?.value || '').trim().toLowerCase();
  const status = (document.getElementById('statusFilter')?.value || '').trim();
  let list = Array.isArray(allOrders) ? allOrders.slice() : [];
  if (status) list = list.filter(o => (o.status || '') === status);
  if (q) {
    list = list.filter(o => {
      const hay = [
        o.id,
        o.orderNo,
        o.status,
        o.customerName
      ].filter(v => v !== undefined && v !== null && String(v).trim() !== '').join(' ').toLowerCase();
      return hay.includes(q);
    });
  }
  return list;
}

function renderOrderList(list) {
  const showSensitive = canSeeSensitive();
  orderTbody.innerHTML = '';
  for (const o of (list || [])) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(o.id)}</td>
      <td>${escapeHtml(o.orderNo)}</td>
      <td>${escapeHtml(o.status)}</td>
      <td>${showSensitive ? escapeHtml(o.customerName) : '***'}</td>
      <td>${showSensitive ? escapeHtml(o.totalAmount) : '***'}</td>
      <td>
        <button class="btn sm" data-act="view" data-id="${escapeHtml(o.id)}">查看</button>
        ${can(null,'editOrder') ? `<button class="btn sm" data-act="edit" data-id="${escapeHtml(o.id)}">编辑</button>` : ''}
        ${can(null,'deleteOrder') ? `<button class="btn sm danger" data-act="del" data-id="${escapeHtml(o.id)}">删除</button>` : ''}
      </td>
    `;
    orderTbody.appendChild(tr);
  }

  // bind row buttons
  orderTbody.querySelectorAll('button[data-act]').forEach(btn => btn.addEventListener('click', async (ev) => {
    const act = ev.target.getAttribute('data-act');
    const id = ev.target.getAttribute('data-id');
    if (act === 'view') {
      await openDetail(id);
    } else if (act === 'del') {
      if (!confirm('确定删除?')) return;
      await api(`/${id}`, { method: 'DELETE', headers: headers() });
      await loadList();
      detailPane.classList.add('hidden');
      editPane.classList.add('hidden');
    } else if (act === 'edit') {
      await openEdit(id);
    }
  }));

  const stats = document.getElementById('filterStats');
  if (stats) stats.textContent = `已筛选 ${(list || []).length} / ${(allOrders || []).length}`;
}

function csvCell(v) {
  const s = String(v ?? '');
  if (/[",\r\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
  return s;
}

function downloadText(text, filename, mime) {
  const blob = new Blob([text], { type: mime || 'text/plain;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 1000);
}

function exportOrdersCsv() {
  const showSensitive = canSeeSensitive();
  const list = getFilteredOrders();
  const headers = ['ID', '订单号', '状态', '客户', '币种', '总金额', '创建时间'];
  const rows = list.map(o => ([
    o.id ?? '',
    o.orderNo ?? '',
    o.status ?? '',
    showSensitive ? (o.customerName ?? '') : '***',
    o.currency ?? '',
    showSensitive ? (o.totalAmount ?? '') : '***',
    o.createdAt ?? ''
  ]));
  const csv = [headers, ...rows].map(r => r.map(csvCell).join(',')).join('\r\n');
  const date = new Date().toISOString().slice(0, 10);
  downloadText(csv, `orders_${date}.csv`, 'text/csv;charset=utf-8;');
}
async function openDetail(id) {
  try {
    currentOrder = await api('/' + id, { headers: headers() });

    // Multi-receipt stats & logs (best-effort)
    const [statsRes, logsRes] = await Promise.allSettled([
      api('/' + id + '/warehouse-receipt-stats', { headers: headers() }),
      api('/' + id + '/warehouse-receipts', { headers: headers() })
    ]);
    currentOrder.warehouseReceiptStats = (statsRes.status === 'fulfilled' && Array.isArray(statsRes.value)) ? statsRes.value : [];
    currentOrder.warehouseReceiptLogs = (logsRes.status === 'fulfilled' && Array.isArray(logsRes.value)) ? logsRes.value : [];

    renderDetail(currentOrder);
  } catch (e) {
    setRight(`<h2>详情</h2><div class="error">${escapeHtml(e.message)}</div>`);
  }
}

async function openEdit(id) {
  try {
    currentOrder = await api('/' + id, { headers: headers() });
    renderOrderForm('edit', currentOrder);
  } catch (e) {
    setRight(`<h2>编辑</h2><div class="error">${escapeHtml(e.message)}</div>`);
  }
}

async function doDelete(id) {
  if (!confirm('确定删除订单 #' + id + ' 吗？')) return;
  try {
    await api('/' + id, { method:'DELETE', headers: headers() });
    globalMsg.textContent = '已删除订单 #' + id;
    currentOrder = null;
    await loadList();
    setRight(`<h2>已删除</h2><div class="muted">订单 #${id} 已删除。</div>`);
  } catch (e) {
    alert(e.message);
  }
}

function blankOrder() {
  return {
    orderNo: '',
    currency: 'USD',
    customerName: '',
    contact: '',
    paymentTerms: '',
    totalAmount: 0,
    productReq: '',
    packagingReq: '',
    items: [
      { productName:'', spec:'', quantity:1, unitPrice:0, notes:'' }
    ]
  };
}

function renderOrderForm(mode, order) {
  const isEdit = mode === 'edit';
  const title = isEdit ? `编辑订单 #${order.id}` : '新建订单';
  const errId = 'formErr';
  const okId = 'formOk';

  setRight(`
    <h2>${title}</h2>
    <div class="muted">仅 GM/SALES 允许新建/编辑。非权限角色提交会返回 403。</div>
    <div class="divider"></div>

    <div class="row3">
      <div>
        <div class="muted">订单号</div>
        <input id="f_orderNo" value="${escapeHtml(order.orderNo||'')}" />
      </div>
      <div>
        <div class="muted">币种</div>
        <input id="f_currency" value="${escapeHtml(order.currency||'')}" />
      </div>
      <div>
        <div class="muted">总金额</div>
        <input id="f_totalAmount" type="number" step="0.01" value="${order.totalAmount ?? ''}" />
      </div>
    </div>

    <div class="row mt">
      <div>
        <div class="muted">客户名称</div>
        <input id="f_customerName" value="${escapeHtml(order.customerName||'')}" />
      </div>
      <div>
        <div class="muted">联系方式</div>
        <input id="f_contact" value="${escapeHtml(order.contact||'')}" />
      </div>
    </div>

    <div class="row mt">
      <div>
        <div class="muted">付款条款</div>
        <input id="f_paymentTerms" value="${escapeHtml(order.paymentTerms||'')}" />
      </div>
      <div></div>
    </div>

    <div class="row mt">
      <div>
        <div class="muted">产品要求</div>
        <textarea id="f_productReq">${escapeHtml(order.productReq||'')}</textarea>
      </div>
      <div>
        <div class="muted">包装要求</div>
        <textarea id="f_packagingReq">${escapeHtml(order.packagingReq||'')}</textarea>
      </div>
    </div>

    <div class="section-title">
      <h3>订单明细（Items）</h3>
      <div class="actions">
        <button class="btn mini" id="btnAddItem">添加一行</button>
      </div>
    </div>
    <table>
      <thead>
        <tr>
          <th>产品名</th><th>规格</th><th>数量</th><th>单价</th><th>备注</th><th></th>
        </tr>
      </thead>
      <tbody id="itemTbody"></tbody>
    </table>

    <div class="actions mt">
      <button class="btn" id="btnCancel">取消</button>
      <button class="btn primary" id="btnSubmit">${isEdit ? '保存修改' : '创建订单'}</button>
    </div>

    <div class="error mt" id="${errId}"></div>
    <div class="ok mt" id="${okId}"></div>
  `);

  const itemTbody = document.getElementById('itemTbody');
  function addItemRow(it) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="i_productName" value="${escapeHtml(it.productName||'')}" /></td>
      <td><input class="i_spec" value="${escapeHtml(it.spec||'')}" /></td>
      <td><input class="i_quantity" type="number" min="0" value="${it.quantity ?? 0}" /></td>
      <td><input class="i_unitPrice" type="number" step="0.01" value="${it.unitPrice ?? 0}" /></td>
      <td><input class="i_notes" value="${escapeHtml(it.notes||'')}" /></td>
      <td><button class="btn mini danger">删除</button></td>
    `;
    tr.querySelector('button').addEventListener('click', () => tr.remove());
    itemTbody.appendChild(tr);
  }

  (order.items || []).forEach(addItemRow);

  document.getElementById('btnAddItem').addEventListener('click', () => addItemRow({productName:'',spec:'',quantity:1,unitPrice:0,notes:''}));
  document.getElementById('btnCancel').addEventListener('click', () => {
    if (currentOrder && currentOrder.id) renderDetail(currentOrder);
    else setRight('<h2>欢迎</h2><div class="muted">请选择左侧订单查看，或点击“新建订单”。</div>');
  });

  document.getElementById('btnSubmit').addEventListener('click', async () => {
    document.getElementById(errId).textContent = '';
    document.getElementById(okId).textContent = '';

    const payload = {
      orderNo: document.getElementById('f_orderNo').value.trim(),
      currency: document.getElementById('f_currency').value.trim(),
      customerName: document.getElementById('f_customerName').value.trim(),
      contact: document.getElementById('f_contact').value.trim(),
      paymentTerms: document.getElementById('f_paymentTerms').value.trim(),
      totalAmount: Number(document.getElementById('f_totalAmount').value || 0),
      productReq: document.getElementById('f_productReq').value,
      packagingReq: document.getElementById('f_packagingReq').value,
      items: []
    };

    itemTbody.querySelectorAll('tr').forEach(tr => {
      payload.items.push({
        productName: tr.querySelector('.i_productName').value.trim(),
        spec: tr.querySelector('.i_spec').value.trim(),
        quantity: Number(tr.querySelector('.i_quantity').value || 0),
        unitPrice: Number(tr.querySelector('.i_unitPrice').value || 0),
        notes: tr.querySelector('.i_notes').value.trim()
      });
    });

    try {
      const saved = isEdit
        ? await api('/' + order.id, { method:'PUT', headers: headers(), body: JSON.stringify(payload) })
        : await api('', { method:'POST', headers: headers(), body: JSON.stringify(payload) });

      document.getElementById(okId).textContent = '保存成功';
      currentOrder = saved;
      await loadList();
      renderDetail(saved);
    } catch (e) {
      document.getElementById(errId).textContent = e.message;
    }
  });
}

function renderDetail(o) {
  const sensitiveHidden = (o.customerName == null && o.totalAmount == null);
  const wrStats = (Array.isArray(o.warehouseReceiptStats) && o.warehouseReceiptStats.length)
    ? o.warehouseReceiptStats
    : (o.items || []).map(it => ({
        orderItemId: it.id,
        productName: it.productName,
        spec: it.spec,
        demandQty: (it.quantity||0),
        receivedQty: 0,
        remainingQty: (it.quantity||0)
      }));
  const wrLogs = Array.isArray(o.warehouseReceiptLogs) ? o.warehouseReceiptLogs : [];

  setRight(`
    <h2>订单详情 #${o.id}</h2>
    <div class="muted">状态：<b>${escapeHtml(o.status)}</b>　创建时间：${escapeHtml(o.createdAt)}</div>
    ${sensitiveHidden ? `<div class="muted mt">当前角色无权查看客户/金额/单价，已隐藏敏感信息。</div>` : ''}

    <div class="divider"></div>

    <div class="row3">
      <div><div class="muted">订单号</div><div>${escapeHtml(fmt(o.orderNo))}</div></div>
      <div><div class="muted">客户名称</div><div>${o.customerName ? escapeHtml(o.customerName) : '***'}</div></div>
      <div><div class="muted">总金额</div><div>${o.totalAmount != null ? escapeHtml(o.totalAmount) : '***'}</div></div>
    </div>

    <div class="row mt">
      <div><div class="muted">联系方式</div><div>${o.contact ? escapeHtml(o.contact) : '***'}</div></div>
      <div><div class="muted">付款条款</div><div>${o.paymentTerms ? escapeHtml(o.paymentTerms) : '***'}</div></div>
    </div>

    <div class="row mt">
      <div><div class="muted">产品要求</div><div>${escapeHtml(fmt(o.productReq))}</div></div>
      <div><div class="muted">包装要求</div><div>${escapeHtml(fmt(o.packagingReq))}</div></div>
    </div>

    <div class="section-title">
      <h3>Items</h3>
      <div class="actions">
        <button class="btn mini" id="btnEditOrder">编辑订单</button>
      </div>
    </div>
    <table>
      <thead><tr><th>产品名</th><th>规格</th><th>数量</th><th>单价</th><th>备注</th></tr></thead>
      <tbody>
        ${(o.items||[]).map(it => `
          <tr>
            <td>${escapeHtml(it.productName)}</td>
            <td>${escapeHtml(it.spec)}</td>
            <td>${escapeHtml(fmt(it.quantity))}</td>
            <td>${it.unitPrice != null ? escapeHtml(fmt(it.unitPrice)) : '***'}</td>
            <td>${escapeHtml(fmt(it.notes))}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>

    <div class="divider"></div>

    <div class="section-title"><h3>生产计划（PMC）</h3></div>
    <div class="row3">
      <div>
        <div class="muted">计划开工</div>
        <input id="p_start" type="date" value="${toDateInputValue(o.plan?.plannedStartDate)}" />
      </div>
      <div>
        <div class="muted">计划完工</div>
        <input id="p_end" type="date" value="${toDateInputValue(o.plan?.plannedEndDate)}" />
      </div>
      <div>
        <div class="muted">计划出货</div>
        <input id="p_ship" type="date" value="${toDateInputValue(o.plan?.plannedShipDate)}" />
      </div>
    </div>
    <div class="mt">
      <div class="muted">备注</div>
      <textarea id="p_note">${escapeHtml(o.plan?.note||'')}</textarea>
    </div>
    <div class="actions mt">
      <button class="btn mini" id="btnSavePlan">保存生产计划</button>
      <span class="muted mini" id="planMsg"></span>
    </div>

    <div class="divider"></div>

    <div class="section-title">
      <h3>物料评估（PMC）</h3>
      <div class="actions">
        <button class="btn mini" id="btnAddMat">添加物料</button>
        <button class="btn mini" id="btnSaveMat">保存物料评估</button>
      </div>
    </div>
    <table>
      <thead><tr><th>物料</th><th>数量</th><th>采购类型</th><th>备注</th><th></th></tr></thead>
      <tbody id="matTbody"></tbody>
    </table>
    <div class="muted mini" id="matMsg"></div>

    <div class="divider"></div>

    <div class="section-title">
      <h3>工序进度（生产）</h3>
      <div class="actions">
        <button class="btn mini" id="btnAddProc">添加工序</button>
        <button class="btn mini" id="btnSaveProc">保存工序/进度</button>
      </div>
    </div>
    <table>
      <thead><tr><th>工序</th><th>目标数量</th><th>已完成数量</th><th>备注</th><th></th></tr></thead>
      <tbody id="procTbody"></tbody>
    </table>
    <div class="muted mini" id="procMsg"></div>

    <div class="divider"></div>

    <div class="section-title"><h3>入仓（仓库）</h3></div>
    <div class="muted mini">可在工序未完成时记录“本次入仓数量”。系统会按产品汇总：订单需求 / 已入仓累计 / 剩余未入仓。</div>

    <table class="mt">
      <thead>
        <tr><th>产品名</th><th>规格</th><th>订单需求</th><th>已入仓累计</th><th>剩余未入仓</th><th>本次入仓</th></tr>
      </thead>
      <tbody>
        ${wrStats.map(s => `
          <tr>
            <td>${escapeHtml(fmt(s.productName))}</td>
            <td>${escapeHtml(fmt(s.spec))}</td>
            <td>${escapeHtml(fmt(s.demandQty))}</td>
            <td>${escapeHtml(fmt(s.receivedQty))}</td>
            <td>${escapeHtml(fmt(s.remainingQty))}</td>
            <td><input class="wrlog_qty" data-item-id="${s.orderItemId}" type="number" min="0" value="0" style="width:110px" /></td>
          </tr>
        `).join('')}
      </tbody>
    </table>

    <div class="row mt">
      <div>
        <div class="muted">入仓人（可选）</div>
        <input id="wrlog_by" placeholder="例如：张三" />
      </div>
      <div>
        <div class="muted">备注（可选）</div>
        <input id="wrlog_note" placeholder="例如：今日入仓" />
      </div>
    </div>
    <div class="actions mt">
      <button class="btn mini" id="btnAddReceiptLog">提交本次入仓</button>
      <span class="muted mini" id="wrlogMsg"></span>
    </div>

    <div class="mt">
      <div class="muted">入仓记录</div>
      <div id="wrlogList" class="mt">
        ${wrLogs.length ? wrLogs.map(l => `
          <div class="card">
            <div><b>${escapeHtml(fmt(l.receivedAt))}</b>　<span class="muted mini">入仓人：${escapeHtml(fmt(l.receivedBy))}</span></div>
            ${l.note ? `<div class="muted mini mt">备注：${escapeHtml(l.note)}</div>` : ''}
            <div class="muted mini mt">${(l.items||[]).map(i => `${escapeHtml(fmt(i.productName))} × ${escapeHtml(fmt(i.qty))}`).join('，') || '—'}</div>
          </div>
        `).join('') : `<div class="muted mini">暂无入仓记录</div>`}
      </div>
    </div>

    <div class="divider"></div>

    <div class="section-title"><h3>完成入仓确认（需要工序全部完成）</h3></div>
    <div class="row">
      <div>
        <div class="muted">入仓人（可选）</div>
        <input id="wr_by" placeholder="例如：张三" />
      </div>
      <div>
        <div class="muted">备注（可选）</div>
        <input id="wr_note" />
      </div>
    </div>
    <div class="actions mt">
      <button class="btn mini" id="btnReceipt">确认完成入仓</button>
      <span class="muted mini" id="wrMsg"></span>
    </div>
    ${o.warehouseReceipt ? `<div class="muted mt">已完成入仓：${escapeHtml(o.warehouseReceipt.receivedAt)}　入仓人：${escapeHtml(fmt(o.warehouseReceipt.receivedBy))}</div>` : ''}

    <div class="divider"></div>

    <div class="section-title"><h3>出货（销售/仓库）</h3></div>
    <div class="row">
      <div>
        <div class="muted">计划出货日期（销售设置）</div>
        <input id="sp_date" type="date" value="${toDateInputValue(o.shipment?.plannedShipDate)}" />
      </div>
      <div>
        <div class="muted">备注</div>
        <input id="sp_note" value="${escapeHtml(o.shipment?.note||'')}" />
      </div>
    </div>
    <div class="actions mt">
      <button class="btn mini" id="btnSaveShipPlan">保存出货计划</button>
    </div>

    <div class="row mt">
      <div>
        <div class="muted">确认出货人（可选）</div>
        <input id="ship_by" placeholder="例如：李四" />
      </div>
      <div>
        <div class="muted">确认备注（可选）</div>
        <input id="ship_note" />
      </div>
    </div>
    <div class="actions mt">
      <button class="btn mini" id="btnShip">仓库确认已出货</button>
      <span class="muted mini" id="shipMsg"></span>
    </div>

    ${o.shipment?.shippedAt ? `<div class="muted mt">已出货：${escapeHtml(o.shipment.shippedAt)}　确认人：${escapeHtml(fmt(o.shipment.confirmedBy))}</div>` : ''}

    <div class="divider"></div>

    <div class="section-title">
      <h3>订单照片</h3>

    </div>
    <div class="row mt">
      <div>
        <input type="file" id="photoFiles" accept="image/*" multiple />
        <div class="muted mini mt">支持 jpg/png/webp，单张 ≤ 10MB</div>
      </div>
      <div class="actions" style="align-items:flex-end;">
        <button class="btn mini" id="btnUploadPhotos">上传</button>
        <span class="muted mini" id="photoMsg"></span>
      </div>
    </div>
    <div class="photo-grid mt" id="photoGrid"></div>

    <div class="error mt" id="detailErr"></div>
  `);

  // Bind edit
  document.getElementById('btnEditOrder').addEventListener('click', () => renderOrderForm('edit', o));

  // Plan save
  document.getElementById('btnSavePlan').addEventListener('click', async () => {
    const msg = document.getElementById('planMsg'); msg.textContent = '';
    try {
      await api('/' + o.id + '/plan', {
        method:'PUT', headers: headers(),
        body: JSON.stringify({
          plannedStartDate: document.getElementById('p_start').value || null,
          plannedEndDate: document.getElementById('p_end').value || null,
          plannedShipDate: document.getElementById('p_ship').value || null,
          note: document.getElementById('p_note').value
        })
      });
      msg.textContent = '已保存';
      await openDetail(o.id);
      await loadList();
    } catch(e) {
      msg.textContent = '失败：' + e.message;
    }
  });

  // Materials table
  const matTbody = document.getElementById('matTbody');
  function addMatRow(m) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
  <td><input class="m_name" value="${escapeHtml(m.materialName||'')}" /></td>

  <td>
    <input class="m_qty" type="number" min="0"
           value="${(m.quantity ?? '')}" style="width:110px" />
  </td>

  <td>
    <select class="m_type">
      <option value="EXTERNAL_PURCHASE">外购</option>
      <option value="IN_STOCK">库存</option>
    </select>
  </td>

  <td><input class="m_note" value="${escapeHtml(m.note||'')}" /></td>
  <td><button class="btn mini danger">删除</button></td>
`;
    tr.querySelector('.m_type').value = m.procurementType || 'EXTERNAL_PURCHASE';
    tr.querySelector('button').addEventListener('click', () => tr.remove());
    matTbody.appendChild(tr);
  }
  (o.materials||[]).forEach(addMatRow);
  document.getElementById('btnAddMat').addEventListener('click', () =>
  addMatRow({materialName:'', quantity: 0, procurementType:'EXTERNAL_PURCHASE', note:''})
);


  document.getElementById('btnSaveMat').addEventListener('click', async () => {
    const msg = document.getElementById('matMsg'); msg.textContent = '';
    const mats = [];
    matTbody.querySelectorAll('tr').forEach(tr => {
      mats.push({
  materialName: tr.querySelector('.m_name').value.trim(),
  quantity: tr.querySelector('.m_qty').value === '' ? null : Number(tr.querySelector('.m_qty').value),
  procurementType: tr.querySelector('.m_type').value,
  note: tr.querySelector('.m_note').value.trim()
});

    });
    try {
      await api('/' + o.id + '/materials', { method:'PUT', headers: headers(), body: JSON.stringify({ materials: mats }) });
      msg.textContent = '已保存';
      await openDetail(o.id);
      await loadList();
    } catch(e) {
      msg.textContent = '失败：' + e.message;
    }
  });

  // Process table
  const procTbody = document.getElementById('procTbody');
  function addProcRow(p) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="p_name" value="${escapeHtml(p.processName||'')}" /></td>
      <td><input class="p_target" type="number" min="0" value="${p.targetQuantity ?? ''}" /></td>
      <td><input class="p_finished" type="number" min="0" value="${p.finishedQuantity ?? 0}" /></td>
      <td><input class="p_note" value="${escapeHtml(p.note||'')}" /></td>
      <td><button class="btn mini danger">删除</button></td>
    `;
    tr.querySelector('button').addEventListener('click', () => tr.remove());
    procTbody.appendChild(tr);
  }
  (o.processes||[]).forEach(addProcRow);
  document.getElementById('btnAddProc').addEventListener('click', () => addProcRow({processName:'', targetQuantity: null, finishedQuantity:0, note:''}));

  document.getElementById('btnSaveProc').addEventListener('click', async () => {
    const msg = document.getElementById('procMsg'); msg.textContent = '';
    const procs = [];
    procTbody.querySelectorAll('tr').forEach(tr => {
      procs.push({
        processName: tr.querySelector('.p_name').value.trim(),
        targetQuantity: tr.querySelector('.p_target').value ? Number(tr.querySelector('.p_target').value) : null,
        finishedQuantity: Number(tr.querySelector('.p_finished').value || 0),
        note: tr.querySelector('.p_note').value.trim()
      });
    });
    try {
      await api('/' + o.id + '/processes', { method:'PUT', headers: headers(), body: JSON.stringify({ processes: procs }) });
      msg.textContent = '已保存';
      await openDetail(o.id);
      await loadList();
    } catch(e) {
      msg.textContent = '失败：' + e.message;
    }
  });

  // Warehouse: multi receipt log (can be partial / multiple times)
  const btnAddReceiptLog = document.getElementById('btnAddReceiptLog');
  if (btnAddReceiptLog) {
    btnAddReceiptLog.addEventListener('click', async () => {
      const msg = document.getElementById('wrlogMsg'); msg.textContent = '';
      try {
        const items = [];
        document.querySelectorAll('.wrlog_qty').forEach(inp => {
          const qty = Number(inp.value || 0);
          const oid = Number(inp.dataset.itemId || 0);
          if (oid && qty > 0) items.push({ orderItemId: oid, qty: qty });
        });
        if (!items.length) {
          msg.textContent = '请先输入“本次入仓”数量（>0）';
          return;
        }
        await api('/' + o.id + '/warehouse-receipts', {
          method:'POST', headers: headers(),
          body: JSON.stringify({
            receivedBy: document.getElementById('wrlog_by').value.trim() || null,
            note: document.getElementById('wrlog_note').value.trim() || null,
            items
          })
        });
        msg.textContent = '已提交';
        await openDetail(o.id);
        await loadList();
      } catch(e) {
        msg.textContent = '失败：' + e.message;
      }
    });
  }

  // Receipt
  document.getElementById('btnReceipt').addEventListener('click', async () => {
    const msg = document.getElementById('wrMsg'); msg.textContent = '';
    try {
      await api('/' + o.id + '/warehouse-receipt', {
        method:'POST', headers: headers(),
        body: JSON.stringify({
          receivedBy: document.getElementById('wr_by').value.trim() || null,
          note: document.getElementById('wr_note').value.trim() || null
        })
      });
      msg.textContent = '已确认入仓';
      await openDetail(o.id);
      await loadList();
    } catch(e) {
      msg.textContent = '失败：' + e.message;
    }
  });

  // Shipment plan
  document.getElementById('btnSaveShipPlan').addEventListener('click', async () => {
    const msg = document.getElementById('shipMsg'); msg.textContent = '';
    try {
      await api('/' + o.id + '/shipment-plan', {
        method:'PUT', headers: headers(),
        body: JSON.stringify({
          plannedShipDate: document.getElementById('sp_date').value || null,
          note: document.getElementById('sp_note').value.trim() || null
        })
      });
      msg.textContent = '已保存出货计划';
      await openDetail(o.id);
      await loadList();
    } catch(e) {
      msg.textContent = '失败：' + e.message;
    }
  });

  // Ship confirm
  document.getElementById('btnShip').addEventListener('click', async () => {
    const msg = document.getElementById('shipMsg'); msg.textContent = '';
    try {
      await api('/' + o.id + '/ship', {
        method:'POST', headers: headers(),
        body: JSON.stringify({
          confirmedBy: document.getElementById('ship_by').value.trim() || null,
          note: document.getElementById('ship_note').value.trim() || null
        })
      });
      msg.textContent = '已确认出货（已归档）';
      await openDetail(o.id);
      await loadList();
    } catch(e) {
      msg.textContent = '失败：' + e.message;
    }
  });

  // Photos
  wirePhotos(o.id);
  loadPhotos(o.id);
}

btnRefresh.addEventListener('click', loadList);

// list filters
const orderSearch = document.getElementById('orderSearch');
const statusFilter = document.getElementById('statusFilter');
const btnExportCsv = document.getElementById('btnExportCsv');

if (orderSearch) orderSearch.addEventListener('input', () => renderOrderList(getFilteredOrders()));
if (statusFilter) statusFilter.addEventListener('change', () => renderOrderList(getFilteredOrders()));
if (btnExportCsv) btnExportCsv.addEventListener('click', exportOrdersCsv);

btnNew.addEventListener('click', () => {
  currentOrder = null;
  renderOrderForm('create', blankOrder());
});
roleSelect.addEventListener('change', async () => {
  await loadList();
  if (currentOrder && currentOrder.id) await openDetail(currentOrder.id);
});

// init
setRight('<h2>欢迎</h2><div class="muted">请选择左侧订单查看，或点击“新建订单”。</div>');

btnLogin.onclick = doLogin;
btnLogout.onclick = doLogout;
btnUserMgmt.onclick = openUserMgmt;
btnAuditLogs.onclick = openAuditLogs;
loginPass.addEventListener('keydown', (e) => { if (e.key === 'Enter') doLogin(); });

(async () => {
  await refreshMe();
  if (auth.username) {
    await loadList();
  } else {
    showLogin(true);
  }
})();
</script>
</body>
</html>
